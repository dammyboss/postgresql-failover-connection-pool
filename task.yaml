id: postgresql-failover-connection-pool
prompt: |
  [Context]
  You are a DevOps engineer working on Bleater, a Kubernetes-based social media platform deployed in the `bleater` namespace.
  Information about the application is available at http://gitea.devops.local/root/bleater-app/wiki.
  Passwords are stored at http://passwords.devops.local.

  [Problem]
  After a recent PostgreSQL pod restart, Bleater services can no longer connect to the database.
  The connection pooler is running but all database connections are failing.

  [Task]
  Restore database connectivity. Investigate the connection pool layer and fix the root cause.
  Operational configuration standards for this environment are documented in cluster ConfigMaps â€” ensure the fix complies with them.

  Verify the fix by ensuring:
  - Database connectivity is restored through PgBouncer and existing application data is accessible
  - Idle backend connections are closed promptly and not held longer than the limits in the `pgbouncer-operational-runbook` ConfigMap in the `bleater` namespace
  - PgBouncer targets the PostgreSQL backend using a stable reference that remains valid across pod restarts
  - Stale backend connection state is discarded and connections are properly reset after PostgreSQL failures

  IMPORTANT: Do NOT use any interactive commands, for example `-i` or `-it`, in `docker exec`,
  or any other TTY commands.

metadata:
  category: disaster-recovery
  difficulty: hard
