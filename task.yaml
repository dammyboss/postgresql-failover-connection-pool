id: postgresql-failover-connection-pool
prompt: |
  [Context]
  You are a DevOps engineer working on Bleater, a Kubernetes-based social media platform deployed in the `bleater` namespace.
  Information about the application is available at http://gitea.devops.local/root/bleater-app/wiki.
  Passwords are stored at http://passwords.devops.local.

  [Problem]
  After a recent PostgreSQL pod restart, Bleater services can no longer connect to the database.
  The connection pooler is running but all database connections are failing.
  `server_reset_query` is not configured in PgBouncer, preventing proper connection cleanup
  after backend failures.

  [Task]
  Restore database connectivity. Investigate the connection pool layer and fix the root cause.

  Verify the fix by ensuring:
  - Database connectivity is restored through PgBouncer and existing application data is accessible
  - Connection pool server and idle timeout values are tuned to prevent stale backend connections
  - The fix handles future pod lifecycle events without manual intervention
  - PgBouncer is configured with `server_reset_query` for proper connection cleanup after backend failures

  IMPORTANT: Do NOT use any interactive commands, for example `-i` or `-it`, in `docker exec`,
  or any other TTY commands.

metadata:
  category: disaster-recovery
  difficulty: hard
